# HIP-02: File Encryption Standard

`draft` `mandatory`

This document specifies the file encryption standard for Hengdang protocol.

## Abstract

Hengdang uses a multi-layered encryption approach where each file has its own encryption key, which is then encrypted using the owner's master key. This specification defines the cryptographic standards for file encryption, key wrapping, and metadata protection.

## Specification

### 1. File Key Generation
- Generate random 256-bit key for AES-256-GCM
- Generate random 96-bit IV for each encryption operation
- Structure:
  ```typescript
  interface FileKey {
    key: Buffer; // 32 bytes
    iv: Buffer;  // 12 bytes
  }
  ```

### 2. Content Encryption
- Algorithm: AES-256-GCM
- Key size: 256 bits
- IV size: 96 bits
- Auth tag size: 128 bits
- Format: IV + Auth Tag + Encrypted Content
  ```
  [12 bytes IV][16 bytes Auth Tag][N bytes Encrypted Content]
  ```

### 3. Metadata Encryption
- Same algorithm as content encryption (AES-256-GCM)
- Uses same file key as content
- Metadata structure:
  ```typescript
  interface FileMetadata {
    name: string;
    size: number;
    mimeType?: string;
  }
  ```
- Process:
  1. Convert metadata to JSON string
  2. Encrypt using file key
  3. Format: IV + Auth Tag + Encrypted Metadata

### 4. File Key Encryption
- Derive encryption key from master private key using SHA-256
- Use AES-256-GCM to encrypt file key
- Format: IV + Auth Tag + Encrypted Key
  ```
  [12 bytes IV][16 bytes Auth Tag][44 bytes Encrypted Key]
  ```

### 5. File Storage Format
Three separate files are created:
1. `<filename>.encrypted`: Encrypted file content
2. `<filename>.metadata`: Encrypted file metadata
3. `<filename>.wrapped`: Encrypted file key

## Encryption Process

1. **Generate File Key**
   ```typescript
   fileKey = {
     key: randomBytes(32),
     iv: randomBytes(12)
   }
   ```

2. **Encrypt Content**
   ```typescript
   cipher = createCipheriv('aes-256-gcm', fileKey.key, fileKey.iv)
   encryptedContent = concat([
     fileKey.iv,
     cipher.update(content),
     cipher.final(),
     cipher.getAuthTag()
   ])
   ```

3. **Encrypt Metadata**
   ```typescript
   metadataString = JSON.stringify(metadata)
   encryptedMetadata = encrypt(metadataString, fileKey)
   ```

4. **Encrypt File Key**
   ```typescript
   masterKeyBytes = Buffer.from(masterPrivateKey, 'hex')
   derivedKey = sha256(masterKeyBytes)
   wrappingIv = randomBytes(12)
   cipher = createCipheriv('aes-256-gcm', derivedKey, wrappingIv)
   encryptedKey = concat([
     wrappingIv,
     cipher.update(fileKey),
     cipher.final(),
     cipher.getAuthTag()
   ])
   ```

## Decryption Process

1. **Decrypt File Key**
   ```typescript
   masterKeyBytes = Buffer.from(masterPrivateKey, 'hex')
   derivedKey = sha256(masterKeyBytes)
   iv = encryptedKey.slice(0, 12)
   authTag = encryptedKey.slice(12, 28)
   wrappedKey = encryptedKey.slice(28)
   decipher = createDecipheriv('aes-256-gcm', derivedKey, iv)
   decipher.setAuthTag(authTag)
   fileKey = decipher.update(wrappedKey) + decipher.final()
   ```

2. **Decrypt Content**
   ```typescript
   iv = encryptedContent.slice(0, 12)
   authTag = encryptedContent.slice(12, 28)
   content = encryptedContent.slice(28)
   decipher = createDecipheriv('aes-256-gcm', fileKey.key, iv)
   decipher.setAuthTag(authTag)
   decryptedContent = decipher.update(content) + decipher.final()
   ```

3. **Decrypt Metadata**
   ```typescript
   decryptedMetadata = decrypt(encryptedMetadata, fileKey)
   metadata = JSON.parse(decryptedMetadata)
   ```

## Security Considerations

1. **Key Management**
   - Generate new file key for each file
   - Never reuse IVs
   - Protect master private key
   - Verify auth tags before decryption

2. **Implementation Requirements**
   - Use secure random number generator
   - Validate all cryptographic operations
   - Handle decryption errors securely
   - Clear sensitive data from memory

3. **Storage Security**
   - Store encrypted components separately
   - Maintain file integrity
   - Backup encrypted keys
   - Version control for format changes

## Test Vectors

### Test Vector 1
```
File Key:
  key: 0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef
  iv:  0123456789abcdef0123456789abcdef

Content: "Hello, World!"
Metadata: {"name": "test.txt", "size": 13}

Master Private Key:
1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef

Encrypted Content (hex):
0123456789abcdef0123456789abcdef // IV
e8dc4081b13434b45189a720b0363648 // Auth tag
7b5b546573742c20576f726c64215d   // Encrypted data

Encrypted Metadata (hex):
... [similar format to content] ...

Encrypted File Key (hex):
... [similar format to content] ...
```

## References

1. [AES-GCM Specification](https://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-38d.pdf)
2. [SHA-256 Specification](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.180-4.pdf)
3. [Cryptographic Random Number Generation](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-90Ar1.pdf)
