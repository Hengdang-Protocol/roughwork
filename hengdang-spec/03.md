# HIP-03: Key Sharing Protocol

`draft` `mandatory`

This document specifies the key sharing protocol for Hengdang, enabling secure file sharing between users.

## Abstract

Hengdang enables secure file sharing by allowing users to wrap file keys for specific recipients using their public keys. This specification defines the cryptographic standards for key sharing and the format of shared key files.

## Specification

### 1. Key Wrapping
- Use ECDH with secp256k1 for shared secret derivation
- Generate ephemeral key pair for perfect forward secrecy
- Use AES-256-GCM for key wrapping
- Format: Ephemeral Public Key + IV + Auth Tag + Wrapped Key
  ```
  [33 bytes EPK][12 bytes IV][16 bytes Auth Tag][N bytes Wrapped Key]
  ```

### 2. Wrapping Process
1. Generate ephemeral secp256k1 key pair
2. Perform ECDH with recipient's public key
3. Use shared secret as key for AES-256-GCM
4. Encrypt file key (both key and IV)
5. Combine components into final format

### 3. Unwrapping Process
1. Extract ephemeral public key from wrapped data
2. Perform ECDH with recipient's private key
3. Use shared secret to decrypt wrapped key
4. Validate using auth tag
5. Split result into key and IV components

### 4. File Naming Convention
Shared key files use the format:
```
<original_file>.shared.<recipient_hpub>
```

## Key Wrapping Process

1. **Generate Ephemeral Key Pair**
   ```typescript
   ephemeralPrivateKey = randomBytes(32)
   ephemeralPublicKey = secp256k1.getPublicKey(ephemeralPrivateKey)
   ```

2. **Compute Shared Secret**
   ```typescript
   recipientPubKey = hpubToPublicKey(recipientHpub)
   sharedSecret = secp256k1.getSharedSecret(
     ephemeralPrivateKey,
     recipientPubKey
   )
   ```

3. **Wrap Key**
   ```typescript
   iv = randomBytes(12)
   cipher = createCipheriv('aes-256-gcm', sharedSecret, iv)
   wrappedKey = Buffer.concat([
     cipher.update(fileKey),
     cipher.final()
   ])
   authTag = cipher.getAuthTag()
   ```

4. **Combine Components**
   ```typescript
   finalWrappedKey = Buffer.concat([
     ephemeralPublicKey,
     iv,
     authTag,
     wrappedKey
   ])
   ```

## Key Unwrapping Process

1. **Extract Components**
   ```typescript
   ephemeralPublicKey = wrappedKeyData.slice(0, 33)
   iv = wrappedKeyData.slice(33, 45)
   authTag = wrappedKeyData.slice(45, 61)
   wrappedKey = wrappedKeyData.slice(61)
   ```

2. **Compute Shared Secret**
   ```typescript
   sharedSecret = secp256k1.getSharedSecret(
     recipientPrivateKey,
     ephemeralPublicKey
   )
   ```

3. **Unwrap Key**
   ```typescript
   decipher = createDecipheriv('aes-256-gcm', sharedSecret, iv)
   decipher.setAuthTag(authTag)
   fileKey = Buffer.concat([
     decipher.update(wrappedKey),
     decipher.final()
   ])
   ```

## Security Considerations

1. **Perfect Forward Secrecy**
   - New ephemeral key pair for each sharing operation
   - Compromise of long-term keys doesn't expose past shared keys
   - Shared secrets never stored, only used transiently

2. **Key Validation**
   - Validate all public keys before use
   - Verify HPUB format and checksum
   - Validate auth tags before decryption

3. **Implementation Requirements**
   - Use secure random number generator for ephemeral keys
   - Clear sensitive data from memory after use
   - Handle decryption errors securely

## Test Vectors

### Test Vector 1
```
Sender's Private Key:
1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef

Recipient's Public Key (hex):
02dff1d77f2a671c5f36183726db2341be58feae1da2deced843240f7b502ba659

Recipient's HPUB:
hpub1f2jfhqmxcjhz9k5jc4h8zj6c8w9gf0v3s5q2m7x8y9n3p4r5t6v7w8x9y

File Key:
  key: 0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef
  iv:  0123456789abcdef0123456789abcdef

Wrapped Key Format:
[33 bytes Ephemeral Public Key]
[12 bytes IV]
[16 bytes Auth Tag]
[44 bytes Wrapped Key]
```

## References

1. [ECDH Specification](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-56Ar3.pdf)
2. [secp256k1](https://www.secg.org/sec2-v2.pdf)
3. [AES-GCM](https://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-38d.pdf)
